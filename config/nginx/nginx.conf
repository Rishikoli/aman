     elay;
     rst=20 nod zone=api buit_req         lim   on /api/ {
      locatind API
  cke     # Ba

    }        86400;
eoutread_timxy_         prorade;
   http_upg $ache_bypass  proxy_c       ;
   roto $schemeded-P-Forwarset_header Xxy_       pro    or;
 rded_fx_forway_add_ $proxorwarded-Forr X-Fxy_set_heade         pror;
   dd_aoteal-IP $remader X-Rexy_set_he  pro         st;
 hoHost $_set_header     proxy      de';
  pgraection 'unn Coeaderroxy_set_h           pupgrade;
 de $http_raUpgheader y_set_ox      pr  
    1;rsion 1.vey_http_prox          end;
  ront http://fxy_pass       pro   on / {
      locatition
    pplicantend a# Fro      
  ut 10m;
ion_timeo ssl_sess0m;
       red:SSL:1he sha_cacssion ssl_se    s off;
   pherer_ciservl_prefer_ ss     A384;
  GCM-SH-RSA-AES256-384:DHE-SHA256-GCMHE-RSA-AESECDSHA512:6-GCM-S252:DHE-RSA-AEGCM-SHA51AES256-ECDHE-RSA-sl_ciphers ;
        s TLSv1.3TLSv1.2l_protocols    ss.pem;
     l/keyginx/sstc/ncate_key /el_certifi     sspem;
   x/ssl/cert.nginte /etc/ertifica     ssl_cn
   guratioSL confi# S      m;

  omain.co.your-dwwomain.com wour-d yver_name     ser;
   sl http2ten 443 s   lis{
     erver ver
    s HTTPS serain # M

   ;
    }uest_uri$host$req https://return 301        ;
er_name _erv s;
         listen 80   
   server {
    ct redireTPSTP to HTHT
    # 32;
    }
keepalive 
        088;set:8super    server {
    set tream super ups    }

   2;
e 3  keepaliv;
      01nd:30backe server 
       end {stream back
    up
    }
32;ve    keepali  :3000;
    frontend   servernd {
     ronteupstream f
    eam servers   # Upstr

 ays;omains" alwdeSubD00; inclu15360"max-age=3Security -Transport-eader Strict   add_h
 block";ode=n "1; mS-Protectio_header X-XS
    addf;snifions noType-OptContent-_header X-
    addNY;Options DEame-header X-Frrs
    add_ headety # Securi
   1r/s;
te=0m ra=login:1_addr zoney_remotenarbine $eq_zomit_r/s;
    lim rate=10rone=api:10 zremote_addrbinary_ $mit_req_zoneling
    limiti # Rate 
   
+xml;/svgimageml
        on/xicati applson
       ion/jcat  appli
      vascriptjaplication/
        apon/xml+rss  applicati      t
vascrip-japlication/x ap    
   t/javascriptex  t      ext/xml
     t  /css
        textext/plain
   ts
      p_type  gzite auth;
  alidast-rev muprivatetore ache no-sed no-cied expirgzip_prox0240;
    in_length 1ip_m;
    gz onip_vary
    gz  gzip on;sion
  ip compresGz

    # kens off;erver_to48;
    s_size 20_max_hashtypes    65;
ut _timeoeepalive
    ky on;elaod   tcp_nh on;
 cp_nopus
    ton; sendfile ngs
   asic setti B #n;

   ess.log maiacclog/nginx/ss_log /var/

    acce"';or_forwarded_fhttp_x" "$_agent_userhttp"$        '          " '
  r_refere$https_sent "_byteus $bodytat     '$s       
        " 'questlocal] "$reser [$time_mote_u$rer - ote_addt main '$remma  log_forat
  ng form    # Loggistream;

ctet-ion/oapplicatype  default_tes;
   nx/mime.typ/etc/ngi    include  {
http
}

accept on;i_lt    mu;
ll
    use epo 1024;ctions_conneorkernts {
    w
eveginx.pid;
r/run/n/varn;
pid  waor.logog/nginx/errlog /var/lerror_
o;ses autorker_procesinx;
wser ngu       
     proxy_pass http://backend;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_cache_bypass $http_upgrade;
            proxy_read_timeout 300;
            proxy_connect_timeout 300;
            proxy_send_timeout 300;
        }

        # Superset Analytics
        location /superset/ {
            proxy_pass http://superset/;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_cache_bypass $http_upgrade;
            proxy_read_timeout 300;
        }

        # Health check endpoint
        location /health {
            access_log off;
            return 200 "healthy\n";
            add_header Content-Type text/plain;
        }

        # Static files caching
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
            add_header X-Content-Type-Options nosniff;
        }

        # Security - Block access to sensitive files
        location ~ /\. {
            deny all;
            access_log off;
            log_not_found off;
        }

        location ~ \.(env|log|conf)$ {
            deny all;
            access_log off;
            log_not_found off;
        }
    }

    # Monitoring endpoints (internal access only)
    server {
        listen 9090;
        server_name localhost;
        allow 127.0.0.1;
        allow 172.20.0.0/16;
        deny all;

        location /metrics {
            proxy_pass http://backend:3001/metrics;
        }

        location /prometheus {
            proxy_pass http://prometheus:9090;
        }

        location /grafana {
            proxy_pass http://grafana:3000;
        }
    }
}